@{
    ViewData["Title"] = "Dashboard Quản trị viên";
    Layout = "_SidebarLayout";
}

@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager

<partial name="_AdminSidebar" />

<div class="main-content">
    <!-- Header -->
    <div class="content-header">
        <div class="header-title-section">
            <h1>Dashboard Quản trị viên</h1>
            <p>Cái nhìn tổng quan về hoạt động hệ thống, số liệu thống kê và cảnh báo.</p>
        </div>
        <div class="header-actions">
            <partial name="_NotificationDropdown" />
        </div>
    </div>

    <!-- Content Body -->
    <div class="content-body">

    <!-- KPI Cards -->
    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-card-header">
                <p class="kpi-label">Tổng người dùng</p>
                <span class="material-symbols-outlined kpi-icon blue">people</span>
            </div>
            <p class="kpi-value">@(ViewBag.TotalUsers ?? 0)</p>
            @if (ViewBag.UsersThisWeek > 0)
            {
                <p class="kpi-description" style="color: #16a34a;">
                    <span style="color: #16a34a;">↑</span> +@(ViewBag.UsersThisWeek) tuần này
                </p>
            }
            else
            {
                <p class="kpi-description" style="color: #6b7280;">Không có thay đổi</p>
            }
        </div>
        <div class="kpi-card">
            <div class="kpi-card-header">
                <p class="kpi-label">Tổng tài liệu</p>
                <span class="material-symbols-outlined kpi-icon" style="color: #9333ea;">description</span>
            </div>
            <p class="kpi-value">@(ViewBag.TotalDocuments ?? 0)</p>
            @if (ViewBag.DocumentsThisMonth > 0)
            {
                <p class="kpi-description" style="color: #16a34a;">
                    <span style="color: #16a34a;">↑</span> +@(ViewBag.DocumentsThisMonth) tháng này
                </p>
            }
            else
            {
                <p class="kpi-description" style="color: #6b7280;">Không có thay đổi</p>
            }
        </div>
        <div class="kpi-card">
            <div class="kpi-card-header">
                <p class="kpi-label">Chờ duyệt</p>
                <span class="material-symbols-outlined kpi-icon" style="color: #f97316;">hourglass_empty</span>
            </div>
            <p class="kpi-value">@(ViewBag.PendingDocuments ?? 0)</p>
            @if (ViewBag.UrgentRequests > 0)
            {
                <p class="kpi-description" style="color: #dc2626;">
                    <span style="color: #dc2626;">!</span> @(ViewBag.UrgentRequests) yêu cầu khẩn cấp
                </p>
            }
            else
            {
                <p class="kpi-description" style="color: #16a34a;">Không có yêu cầu</p>
            }
        </div>
        <div class="kpi-card">
            <div class="kpi-card-header">
                <p class="kpi-label">Trạng thái hệ thống</p>
                <span class="material-symbols-outlined kpi-icon green">dns</span>
            </div>
            <p class="kpi-value">99.9%</p>
            <p class="kpi-description">Lưu trữ sử dụng: @(Math.Round((double)(ViewBag.StoragePercentage ?? 0), 1))% (@(Math.Round((double)(ViewBag.TotalStorageGB ?? 0), 2))GB)</p>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr; gap: 24px; margin-top: 32px;">
        @* Left Column - Recent Activities *@
        <div style="grid-column: 1;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3 class="section-title">Hoạt động gần đây</h3>
                <a href="#" style="color: #0959aa; font-size: 14px; font-weight: 500; text-decoration: none;">Xem tất cả</a>
            </div>
            <div style="background: white; border: 1px solid #dbe0e6; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);">
                <table class="documents-table">
                    <thead>
                        <tr>
                            <th>Sự kiện</th>
                            <th>Người dùng</th>
                            <th>Thời gian</th>
                            <th class="text-right">Chi tiết</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (ViewBag.RecentActivities != null)
                        {
                            var activities = ViewBag.RecentActivities as List<DMS.ViewModels.RecentActivityVM>;
                            @if (activities != null && activities.Any())
                            {
                                @foreach (var activity in activities)
                                {
                                    var activityUser = activity.User;
                                    var iconClass = activity.Type == "document_upload" ? "blue" : "green";
                                    var iconSymbol = activity.Type == "document_upload" ? "upload_file" : "person_add";
                                    var statusBadgeClass = activity.StatusClass == "blue" ? "status-badge blue" :
                                                          activity.StatusClass == "green" ? "status-badge" : 
                                                          activity.StatusClass == "red" ? "status-badge" : "status-badge gray";
                                    var statusBadgeStyle = activity.StatusClass == "green" ? "background: #f0fdf4; color: #16a34a; border-color: rgba(22, 163, 74, 0.2);" :
                                                           activity.StatusClass == "red" ? "background: #fef2f2; color: #dc2626; border-color: rgba(220, 38, 38, 0.2);" : "";
                                    
                                    <tr>
                                        <td>
                                            <div class="document-info">
                                                <div class="document-icon @iconClass">
                                                    <span class="material-symbols-outlined">@iconSymbol</span>
                                                </div>
                                                <div class="document-details">
                                                    <h5>@activity.Title</h5>
                                                    <p>@activity.Description</p>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="instructor-info">
                                                <div class="instructor-avatar" style="background-image: url('https://ui-avatars.com/api/?name=@(activityUser?.FullName ?? "User")&background=1e40af&color=fff')"></div>
                                                <div class="instructor-details">
                                                    <h6>@(activityUser?.FullName ?? "Người dùng")</h6>
                                                </div>
                                            </div>
                                        </td>
                                        <td style="color: #60758a; font-size: 14px;">@activity.TimeAgo</td>
                                        <td>
                                            <div class="action-buttons-group">
                                                @if (!string.IsNullOrEmpty(statusBadgeStyle))
                                                {
                                                    <span class="@statusBadgeClass" style="@statusBadgeStyle">@activity.Status</span>
                                                }
                                                else
                                                {
                                                    <span class="@statusBadgeClass">@activity.Status</span>
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="4" style="text-align: center; padding: 48px; color: #6b7280;">
                                        <span class="material-symbols-outlined" style="font-size: 48px; color: #9ca3af; margin-bottom: 16px;">inbox</span>
                                        <p style="margin: 0;">Chưa có hoạt động gần đây</p>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="4" style="text-align: center; padding: 48px; color: #6b7280;">
                                    <span class="material-symbols-outlined" style="font-size: 48px; color: #9ca3af; margin-bottom: 16px;">inbox</span>
                                    <p style="margin: 0;">Chưa có hoạt động gần đây</p>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        @* Right Column - Alerts and Quick Access *@
        <div style="grid-column: 1;">
            <div style="display: grid; gap: 24px;">
                @* Important Alerts *@
                <div>
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                        <h3 class="section-title" style="margin: 0;">Cảnh báo quan trọng</h3>
                        <span class="material-symbols-outlined" style="color: #dc2626; font-size: 20px;">notifications</span>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        @if (ViewBag.StoragePercentage != null && (double)ViewBag.StoragePercentage > 80)
                        {
                            <div style="background: white; border: 1px solid #dbe0e6; border-radius: 8px; padding: 16px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);">
                                <div style="display: flex; align-items: start; gap: 12px;">
                                    <span class="material-symbols-outlined" style="color: #dc2626; font-size: 24px;">storage</span>
                                    <div>
                                        <h5 style="font-size: 14px; font-weight: 600; color: #111418; margin-bottom: 4px;">Cảnh báo dung lượng</h5>
                                        <p style="font-size: 12px; color: #60758a;">Dung lượng lưu trữ đạt @(Math.Round((double)ViewBag.StoragePercentage, 1))% (@(Math.Round((double)(ViewBag.TotalStorageGB ?? 0), 2))GB). Cân nhắc dọn dẹp hoặc nâng cấp.</p>
                                    </div>
                                </div>
                            </div>
                        }
                        @if (ViewBag.UrgentRequests != null && (int)ViewBag.UrgentRequests > 5)
                        {
                            <div style="background: white; border: 1px solid #dbe0e6; border-radius: 8px; padding: 16px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);">
                                <div style="display: flex; align-items: start; gap: 12px;">
                                    <span class="material-symbols-outlined" style="color: #f97316; font-size: 24px;">warning</span>
                                    <div>
                                        <h5 style="font-size: 14px; font-weight: 600; color: #111418; margin-bottom: 4px;">Nhiều yêu cầu chờ duyệt</h5>
                                        <p style="font-size: 12px; color: #60758a;">Có @(ViewBag.UrgentRequests) yêu cầu đang chờ phê duyệt. Vui lòng xử lý sớm.</p>
                                    </div>
                                </div>
                            </div>
                        }
                        @if ((ViewBag.StoragePercentage == null || (double)ViewBag.StoragePercentage <= 80) && 
                             (ViewBag.UrgentRequests == null || (int)ViewBag.UrgentRequests <= 5))
                        {
                            <div style="background: white; border: 1px solid #dbe0e6; border-radius: 8px; padding: 16px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);">
                                <div style="display: flex; align-items: start; gap: 12px;">
                                    <span class="material-symbols-outlined" style="color: #16a34a; font-size: 24px;">check_circle</span>
                                    <div>
                                        <h5 style="font-size: 14px; font-weight: 600; color: #111418; margin-bottom: 4px;">Hệ thống hoạt động bình thường</h5>
                                        <p style="font-size: 12px; color: #60758a;">Tất cả các dịch vụ đang hoạt động ổn định.</p>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                @* Quick Access *@
                <div>
                    <h3 class="section-title" style="margin-bottom: 16px;">Truy cập nhanh</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                        <a href="@Url.Action("UserManagement", "Admin")" style="background: white; border: 1px solid #dbe0e6; border-radius: 8px; padding: 16px; text-align: center; cursor: pointer; transition: box-shadow 0.2s; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); text-decoration: none; display: block;">
                            <span class="material-symbols-outlined" style="font-size: 32px; color: #0959aa; margin-bottom: 8px;">manage_accounts</span>
                            <p style="font-size: 12px; color: #60758a; font-weight: 500; margin: 0;">QL Người dùng</p>
                        </a>
                        <a href="@Url.Action("Index", "Folder")" style="background: white; border: 1px solid #dbe0e6; border-radius: 8px; padding: 16px; text-align: center; cursor: pointer; transition: box-shadow 0.2s; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); text-decoration: none; display: block;">
                            <span class="material-symbols-outlined" style="font-size: 32px; color: #0959aa; margin-bottom: 8px;">folder_managed</span>
                            <p style="font-size: 12px; color: #60758a; font-weight: 500; margin: 0;">QL Tài liệu</p>
                        </a>
                        <a href="@Url.Action("Reports", "Admin")" style="background: white; border: 1px solid #dbe0e6; border-radius: 8px; padding: 16px; text-align: center; cursor: pointer; transition: box-shadow 0.2s; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); text-decoration: none; display: block;">
                            <span class="material-symbols-outlined" style="font-size: 32px; color: #0959aa; margin-bottom: 8px;">bar_chart</span>
                            <p style="font-size: 12px; color: #60758a; font-weight: 500; margin: 0;">Thống kê</p>
                        </a>
                        <a href="#" style="background: white; border: 1px solid #dbe0e6; border-radius: 8px; padding: 16px; text-align: center; cursor: pointer; transition: box-shadow 0.2s; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); text-decoration: none; display: block;">
                            <span class="material-symbols-outlined" style="font-size: 32px; color: #0959aa; margin-bottom: 8px;">settings</span>
                            <p style="font-size: 12px; color: #60758a; font-weight: 500; margin: 0;">Cấu hình</p>
                        </a>
                    </div>
                </div>

                @* Daily Approvals *@
                <div style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); border-radius: 12px; padding: 24px; color: white; position: relative; overflow: hidden;">
                    <div style="position: absolute; top: 16px; right: 16px;">
                        <span class="material-symbols-outlined" style="font-size: 48px; opacity: 0.2; color: white;">description</span>
                    </div>
                    <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 8px;">Đã duyệt hôm nay</h3>
                    <p style="font-size: 48px; font-weight: 700; margin: 16px 0;">@(ViewBag.ApprovedToday ?? 0)</p>
                    <p style="font-size: 14px; opacity: 0.9; margin-bottom: 16px;">Còn lại: @(ViewBag.PendingDocuments ?? 0)</p>
                    <a href="@Url.Action("Approval", "Document")" class="btn" style="background: rgba(255, 255, 255, 0.2); color: white; border: 1px solid rgba(255, 255, 255, 0.3); align-self: flex-end; text-decoration: none; display: inline-block; padding: 8px 16px; border-radius: 6px;">
                        Xem ngay
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

