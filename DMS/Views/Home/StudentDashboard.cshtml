@{
    ViewData["Title"] = "Dashboard Sinh viên";
    Layout = "_DashboardLayout";
}

@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager

@{
    var currentUser = await UserManager.GetUserAsync(User);
}

<div class="dashboard-header">
    <div class="header-left">
        <div class="logo-icon">
            <span class="material-symbols-outlined icon-fill">school</span>
        </div>
        <h2 class="header-title">Hệ thống Học tập</h2>
    </div>
    <div class="header-nav">
        <a href="@Url.Action("StudentDashboard", "Home")" class="nav-link active">Tổng quan</a>
        <a href="@Url.Action("Library", "Document")" class="nav-link">Thư viện tài liệu</a>
        <a href="@Url.Action("Search", "Document")" class="nav-link">Tìm kiếm</a>
        <a href="@Url.Action("MyCourses", "Home")" class="nav-link">Khóa học của tôi</a>
        <a href="@Url.Action("Schedule", "Home")" class="nav-link">Lịch biểu</a>
    </div>
    <div class="header-actions">
        <partial name="_NotificationDropdown" />
        <div class="user-menu">
            <button class="avatar-btn" id="avatarBtn" style="background-image: url('https://ui-avatars.com/api/?name=@UserManager.GetUserName(User)&background=0959aa&color=fff')"></button>
            <div class="user-dropdown" id="userDropdown">
                <div class="dropdown-header">
                    <div class="dropdown-avatar" style="background-image: url('https://ui-avatars.com/api/?name=@UserManager.GetUserName(User)&background=0959aa&color=fff')"></div>
                    <div class="dropdown-user-info">
                        <div class="dropdown-name">@(currentUser?.FullName ?? UserManager.GetUserName(User))</div>
                        <div class="dropdown-role">Sinh viên</div>
                        @if (!string.IsNullOrEmpty(currentUser?.StudentCode))
                        {
                            <div style="font-size: 12px; color: #6b7280; margin-top: 2px;">MSSV: @currentUser.StudentCode</div>
                        }
                    </div>
                </div>
                <div class="dropdown-divider"></div>
                <form asp-controller="Account" asp-action="Logout" method="post" class="logout-form-inline">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="dropdown-item logout-item">
                        <span class="material-symbols-outlined">logout</span>
                        <span>Đăng xuất</span>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<main class="dashboard-main">
    <div class="dashboard-title-section">
        <div>
            <h1 class="dashboard-title">Dashboard Sinh viên</h1>
            <p class="dashboard-subtitle">Chào mừng trở lại! Quản lý và truy cập tài liệu học tập của bạn.</p>
        </div>
        <div class="action-buttons">
            <a href="@Url.Action("Library", "Document")" class="btn btn-outline" style="text-decoration: none; display: inline-flex; align-items: center; gap: 8px;">
                <span class="material-symbols-outlined">folder</span>
                Thư viện tài liệu
            </a>
            <a href="@Url.Action("Search", "Document")" class="btn btn-primary" style="text-decoration: none; display: inline-flex; align-items: center; gap: 8px;">
                <span class="material-symbols-outlined">search</span>
                Tìm kiếm
            </a>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="kpi-grid">
        <div class="kpi-card orange-border">
            <div class="kpi-card-header">
                <p class="kpi-label">Tài liệu mới</p>
                <span class="material-symbols-outlined kpi-icon orange icon-fill">new_releases</span>
            </div>
            <p class="kpi-value">@(ViewBag.NewDocumentsCount ?? 0)</p>
            <p class="kpi-description">Trong 7 ngày qua</p>
        </div>
        <div class="kpi-card">
            <div class="kpi-card-header">
                <p class="kpi-label">Tài liệu đã tải</p>
                <span class="material-symbols-outlined kpi-icon blue icon-fill">download</span>
            </div>
            <p class="kpi-value">@(ViewBag.DownloadedCount ?? 0)</p>
            <p class="kpi-description">Tổng số tài liệu đã tải</p>
        </div>
        <div class="kpi-card">
            <div class="kpi-card-header">
                <p class="kpi-label">Thư mục đang theo dõi</p>
                <span class="material-symbols-outlined kpi-icon green icon-fill">folder</span>
            </div>
            <p class="kpi-value">@(ViewBag.FollowingFoldersCount ?? 0)</p>
            <p class="kpi-description">Thư mục có tài liệu mới</p>
        </div>
        <div class="kpi-card">
            <div class="kpi-card-header">
                <p class="kpi-label">Khóa học</p>
                <span class="material-symbols-outlined kpi-icon purple icon-fill">book</span>
            </div>
            <p class="kpi-value">@(ViewBag.CoursesCount ?? 0)</p>
            <p class="kpi-description">Số khóa học đang tham gia</p>
        </div>
    </div>

    <!-- Courses Section -->
    <div class="courses-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 class="section-title">Khóa học của tôi</h3>
            <a href="@Url.Action("MyCourses", "Home")" style="color: #0959aa; text-decoration: none; font-size: 14px; font-weight: 500;">
                Xem tất cả →
            </a>
        </div>
        <div class="courses-grid">
            @if (ViewBag.Courses != null && ((List<DMS.Models.Course>)ViewBag.Courses).Any())
            {
                var colors = new[] { "blue", "purple", "green", "orange", "red" };
                var icons = new[] { "book", "code", "language", "psychology", "science" };
                var index = 0;
                @foreach (var course in (List<DMS.Models.Course>)ViewBag.Courses)
                {
                    var colorIndex = index % colors.Length;
                    var iconIndex = index % icons.Length;
                    // Lấy số lượng tài liệu từ dictionary (chỉ file được chia sẻ vào khóa học, không phải file public)
                    var courseDocumentCounts = ViewBag.CourseDocumentCounts as Dictionary<int, int>;
                    var docCount = courseDocumentCounts != null && courseDocumentCounts.ContainsKey(course.Id) 
                        ? courseDocumentCounts[course.Id] 
                        : 0;
                    <div class="course-card">
                        <div class="course-header">
                            <div class="course-info">
                                <div class="course-icon @colors[colorIndex]">
                                    <span class="material-symbols-outlined">@icons[iconIndex]</span>
                                </div>
                                <div class="course-details">
                                    <h4>@course.CourseName</h4>
                                    <p>@course.CourseCode</p>
                                </div>
                            </div>
                        </div>
                        <div class="course-footer" style="margin-top: 12px;">
                            <span>@docCount tài liệu</span>
                            <a href="@Url.Action("CourseDetails", "Home", new { id = course.Id })" style="color: #0959aa; text-decoration: none;">
                                Xem tài liệu →
                            </a>
                        </div>
                    </div>
                    index++;
                }
            }
            else
            {
                <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #9ca3af;">
                    <span class="material-symbols-outlined" style="font-size: 48px; display: block; margin-bottom: 16px;">book_off</span>
                    <p>Chưa có khóa học nào. Vui lòng liên hệ quản trị viên để được thêm vào khóa học.</p>
                </div>
            }
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="search-section">
        <div class="search-box">
            <div class="search-input-wrapper">
                <div class="search-icon">
                    <span class="material-symbols-outlined">search</span>
                </div>
                <input type="text" class="search-input" placeholder="Tìm kiếm tài liệu, khóa học hoặc giảng viên..." />
            </div>
        </div>
        <div class="filter-group">
            <div class="filter-select">
                <span class="material-symbols-outlined filter-icon">filter_list</span>
                <select>
                    <option>Tất cả môn học</option>
                    <option>CNTT & Truyền thông</option>
                    <option>Ngoại ngữ</option>
                    <option>Khoa học cơ bản</option>
                </select>
                <span class="material-symbols-outlined filter-arrow">expand_more</span>
            </div>
            <div class="filter-select">
                <span class="material-symbols-outlined filter-icon">sort</span>
                <select>
                    <option>Mới nhất</option>
                    <option>Đã xem gần đây</option>
                    <option>Ưu tiên cao</option>
                </select>
                <span class="material-symbols-outlined filter-arrow">expand_more</span>
            </div>
        </div>
    </div>

    <!-- Documents Table -->
    <div class="documents-table-wrapper">
        <table class="documents-table">
            <thead>
                <tr>
                    <th style="width: 48px; text-align: center;">
                        <span class="material-symbols-outlined" style="font-size: 16px; color: #9ca3af;">star</span>
                    </th>
                    <th>Tài liệu</th>
                    <th>Giảng viên</th>
                    <th>Ngày đăng</th>
                    <th>Trạng thái</th>
                    <th class="text-right">Hành động</th>
                </tr>
            </thead>
            <tbody>
                @if (ViewBag.Documents != null && ((List<DMS.Models.Document>)ViewBag.Documents).Any())
                {
                    @foreach (var doc in (List<DMS.Models.Document>)ViewBag.Documents)
                    {
                        var isNew = doc.UploadDate >= DateTime.Now.AddDays(-7);
                        var fileIcon = doc.FileName.ToLower().EndsWith(".pdf") ? "picture_as_pdf" :
                                      doc.FileName.ToLower().EndsWith(".doc") || doc.FileName.ToLower().EndsWith(".docx") ? "description" :
                                      doc.FileName.ToLower().EndsWith(".ppt") || doc.FileName.ToLower().EndsWith(".pptx") ? "slideshow" :
                                      doc.FileName.ToLower().EndsWith(".xls") || doc.FileName.ToLower().EndsWith(".xlsx") ? "table_chart" :
                                      "insert_drive_file";
                        var iconColor = doc.FileName.ToLower().EndsWith(".pdf") ? "orange" :
                                       doc.FileName.ToLower().EndsWith(".doc") || doc.FileName.ToLower().EndsWith(".docx") ? "blue" :
                                       doc.FileName.ToLower().EndsWith(".ppt") || doc.FileName.ToLower().EndsWith(".pptx") ? "red" :
                                       doc.FileName.ToLower().EndsWith(".xls") || doc.FileName.ToLower().EndsWith(".xlsx") ? "green" :
                                       "gray";
                        <tr>
                            <td style="text-align: center;">
                                <span class="material-symbols-outlined" style="color: #d1d5db; font-size: 20px;">star_border</span>
                            </td>
                            <td>
                                <div class="document-info">
                                    <div class="document-icon @iconColor">
                                        <span class="material-symbols-outlined">@fileIcon</span>
                                    </div>
                                    <div class="document-details">
                                        <h5>@doc.Title</h5>
                                        <p>Môn: @(doc.Course?.CourseName ?? "N/A")</p>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="instructor-info">
                                    <div class="instructor-avatar" style="background-image: url('https://ui-avatars.com/api/?name=@(doc.User?.FullName ?? "User")&background=1e40af&color=fff')"></div>
                                    <div class="instructor-details">
                                        <h6>@(doc.User?.FullName ?? "N/A")</h6>
                                        <span>@(doc.User?.Faculty ?? "N/A")</span>
                                    </div>
                                </div>
                            </td>
                            <td style="color: #60758a; font-size: 14px;">@doc.UploadDate.ToString("dd MMM, yyyy", new System.Globalization.CultureInfo("vi-VN"))</td>
                            <td>
                                @if (isNew)
                                {
                                    <span class="status-badge blue">
                                        <span class="status-dot blue"></span>
                                        Tài liệu mới
                                    </span>
                                }
                                else
                                {
                                    <span class="status-badge gray">
                                        <span class="material-symbols-outlined" style="font-size: 14px;">history</span>
                                        Đã xem
                                    </span>
                                }
                            </td>
                            <td>
                                <div class="action-buttons-group">
                                    <a href="@Url.Action("Preview", "Document", new { id = doc.Id })" class="action-btn" title="Xem trước">
                                        <span class="material-symbols-outlined" style="font-size: 20px;">visibility</span>
                                    </a>
                                    <a href="@Url.Action("Download", "Document", new { id = doc.Id })" class="action-btn download" title="Tải xuống">
                                        <span class="material-symbols-outlined" style="font-size: 20px;">download</span>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #9ca3af;">
                            <span class="material-symbols-outlined" style="font-size: 48px; display: block; margin-bottom: 16px;">folder_off</span>
                            <p>Chưa có tài liệu nào. Hãy truy cập <a href="@Url.Action("Library", "Document")" style="color: #0959aa;">Thư viện tài liệu</a> để xem các tài liệu có sẵn.</p>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        @if (ViewBag.Documents != null && ((List<DMS.Models.Document>)ViewBag.Documents).Any())
        {
            <div class="pagination-wrapper">
                <div class="pagination-info">
                    Hiển thị <strong>@(((List<DMS.Models.Document>)ViewBag.Documents).Count)</strong> tài liệu gần đây
                </div>
                <a href="@Url.Action("Library", "Document")" class="btn btn-outline" style="text-decoration: none; display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px;">
                    <span>Xem tất cả tài liệu</span>
                    <span class="material-symbols-outlined" style="font-size: 18px;">arrow_forward</span>
                </a>
            </div>
        }
    </div>
</main>

<script>
    // User dropdown toggle
    const avatarBtn = document.getElementById('avatarBtn');
    const userDropdown = document.getElementById('userDropdown');

    if (avatarBtn && userDropdown) {
        avatarBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            userDropdown.classList.toggle('show');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!userDropdown.contains(e.target) && !avatarBtn.contains(e.target)) {
                userDropdown.classList.remove('show');
            }
        });
    }
</script>

