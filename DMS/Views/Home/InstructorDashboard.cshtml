@{
    ViewData["Title"] = "Dashboard Giảng viên";
    Layout = "_SidebarLayout";
}

@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager

<partial name="_InstructorSidebar" />

<div class="main-content">
    <!-- Header -->
    <div class="content-header">
        <div class="header-title-section">
            <h1>Dashboard Giảng viên</h1>
            <p>Chào mừng trở lại! Quản lý tài liệu và theo dõi hiệu quả giảng dạy của bạn.</p>
        </div>
        <div class="header-actions">
            <partial name="_NotificationDropdown" />
        </div>
    </div>

    <!-- Content Body -->
    <div class="content-body">
        <!-- KPI Cards -->
    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-card-header">
                <p class="kpi-label">Tổng số tài liệu</p>
                <span class="material-symbols-outlined kpi-icon blue icon-fill">description</span>
            </div>
            <p class="kpi-value">@(ViewBag.TotalDocuments ?? 0)</p>
        </div>
        <div class="kpi-card">
            <div class="kpi-card-header">
                <p class="kpi-label">Tổng lượt xem</p>
                <span class="material-symbols-outlined kpi-icon green">visibility</span>
            </div>
            <p class="kpi-value">@(ViewBag.TotalViews ?? 0)</p>
        </div>
        <div class="kpi-card">
            <div class="kpi-card-header">
                <p class="kpi-label">Lượt tải xuống</p>
                <span class="material-symbols-outlined kpi-icon" style="color: #9333ea;">download</span>
            </div>
            <p class="kpi-value">@(ViewBag.TotalDownloads ?? 0)</p>
        </div>
        <div class="kpi-card">
            <div class="kpi-card-header">
                <p class="kpi-label">Chờ phê duyệt</p>
                <span class="material-symbols-outlined kpi-icon" style="color: #f97316;">hourglass_empty</span>
            </div>
            <p class="kpi-value">@(ViewBag.RejectedDocuments ?? 0)</p>
        </div>
    </div>

    <!-- Storage Usage Card -->
    @{
        var storageUsedGB = ViewBag.StorageUsedGB ?? 0.0;
        var storageLimitGB = ViewBag.StorageLimitGB ?? 15.0;
        var storagePercentage = ViewBag.StoragePercentage ?? 0.0;
        var storageColor = storagePercentage >= 90 ? "#dc2626" : storagePercentage >= 70 ? "#f97316" : "#16a34a";
    }
    <div style="background: white; border-radius: 12px; padding: 24px; margin-bottom: 24px; border: 1px solid #e5e7eb;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <div>
                <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: #111418;">Dung lượng lưu trữ</h3>
                <p style="margin: 4px 0 0 0; font-size: 14px; color: #6b7280;">Giới hạn: @storageLimitGB.ToString("F2") GB</p>
            </div>
            <div style="text-align: right;">
                <p style="margin: 0; font-size: 24px; font-weight: 700; color: @storageColor;">
                    @storageUsedGB.ToString("F2") <span style="font-size: 16px; font-weight: 500; color: #6b7280;">GB</span>
                </p>
                <p style="margin: 4px 0 0 0; font-size: 12px; color: #6b7280;">
                    @storagePercentage.ToString("F1")% đã sử dụng
                </p>
            </div>
        </div>
        <div style="width: 100%; height: 8px; background: #f3f4f6; border-radius: 4px; overflow: hidden;">
            <div style="width: @storagePercentage.ToString("F1")%; height: 100%; background: @storageColor; transition: width 0.3s ease;"></div>
        </div>
        @if (storagePercentage >= 90)
        {
            <p style="margin: 12px 0 0 0; font-size: 13px; color: #dc2626; display: flex; align-items: center; gap: 6px;">
                <span class="material-symbols-outlined" style="font-size: 16px;">warning</span>
                Dung lượng sắp hết! Vui lòng xóa một số file để giải phóng dung lượng.
            </p>
        }
        else if (storagePercentage >= 70)
        {
            <p style="margin: 12px 0 0 0; font-size: 13px; color: #f97316; display: flex; align-items: center; gap: 6px;">
                <span class="material-symbols-outlined" style="font-size: 16px;">info</span>
                Dung lượng đã sử dụng khá nhiều. Hãy cân nhắc xóa các file không cần thiết.
            </p>
        }
    </div>

    <!-- Courses Section -->
    <div class="courses-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h3 class="section-title">Khóa học đang giảng dạy</h3>
            <a href="#" style="color: #0959aa; font-size: 14px; font-weight: 500; text-decoration: none;">Xem tất cả</a>
        </div>
        <div class="courses-grid">
            @if (ViewBag.Courses != null)
            {
                @foreach (var course in (List<DMS.Models.Course>)ViewBag.Courses)
                {
                    var iconColors = new[] { "blue", "green", "purple" };
                    var iconIndex = course.Id % 3;
                    var icons = new[] { "code", "account_tree", "psychology" };
                    
                    <div class="course-card" style="cursor: pointer;" onclick="window.location.href='@Url.Action("CourseDetails", "Home", new { id = course.Id })'">
                        <div class="course-header">
                            <div class="course-info">
                                <div class="course-icon @iconColors[iconIndex]">
                                    <span class="material-symbols-outlined">@icons[iconIndex]</span>
                                </div>
                                <div class="course-details">
                                    <h4>@course.CourseName</h4>
                                    <p>@course.CourseCode@(!string.IsNullOrEmpty(course.ClassCode) ? $" - {course.ClassCode}" : "")</p>
                                    @{
                                        var courseItemCounts = ViewBag.CourseItemCounts as System.Collections.Generic.Dictionary<int, int>;
                                        var itemCount = courseItemCounts != null && courseItemCounts.ContainsKey(course.Id) 
                                            ? courseItemCounts[course.Id] 
                                            : (course.Documents?.Count ?? 0);
                                    }
                                    <p style="font-size: 12px; color: #60758a; margin-top: 4px;">@itemCount mục</p>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
            @if (ViewBag.Courses == null || ((List<DMS.Models.Course>)ViewBag.Courses).Count == 0)
            {
                <p style="color: #60758a; padding: 16px;">Chưa có khóa học nào</p>
            }
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="search-section">
        <div class="search-box">
            <div class="search-input-wrapper">
                <div class="search-icon">
                    <span class="material-symbols-outlined">search</span>
                </div>
                <input type="text" class="search-input" placeholder="Tìm kiếm tài liệu theo tên, mã môn học..." />
            </div>
        </div>
        <div class="filter-group">
            <div class="filter-select">
                <span class="material-symbols-outlined filter-icon">filter_list</span>
                <select>
                    <option>Tất cả trạng thái</option>
                    <option>Đã duyệt</option>
                    <option>Chờ duyệt</option>
                    <option>Yêu cầu chỉnh sửa</option>
                </select>
                <span class="material-symbols-outlined filter-arrow">expand_more</span>
            </div>
            <div class="filter-select">
                <span class="material-symbols-outlined filter-icon">sort</span>
                <select>
                    <option>Mới nhất</option>
                    <option>Cũ nhất</option>
                    <option>Lượt xem nhiều nhất</option>
                </select>
                <span class="material-symbols-outlined filter-arrow">expand_more</span>
            </div>
        </div>
    </div>

    <!-- Documents Table -->
    <div class="documents-table-wrapper">
        <div style="padding: 16px; border-bottom: 1px solid #dbe0e6;">
            <h3 class="section-title" style="margin: 0;">Tài liệu gần đây</h3>
        </div>
        <table class="documents-table">
            <thead>
                <tr>
                    <th>Tên tài liệu</th>
                    <th>Khóa học</th>
                    <th>Ngày đăng</th>
                    <th>Trạng thái</th>
                    <th class="text-right">Hành động</th>
                </tr>
            </thead>
            <tbody>
                @if (ViewBag.Documents != null && ((List<DMS.Models.Document>)ViewBag.Documents).Any())
                {
                    @foreach (var doc in (List<DMS.Models.Document>)ViewBag.Documents)
                    {
                        var fileExtension = doc.FileName?.Split('.').LastOrDefault()?.ToLower() ?? "";
                        var fileIcon = "insert_drive_file";
                        var fileSizeMB = (doc.FileSize / 1024.0 / 1024.0).ToString("F1");
                        
                        if (fileExtension == "pdf") fileIcon = "picture_as_pdf";
                        else if (fileExtension == "doc" || fileExtension == "docx") fileIcon = "description";
                        else if (fileExtension == "ppt" || fileExtension == "pptx") fileIcon = "slideshow";
                        else if (fileExtension == "xls" || fileExtension == "xlsx") fileIcon = "table_chart";

                        var statusBadgeClass = "";
                        var statusText = "";
                        var statusIcon = "";
                        
                        if (doc.Status == DMS.Models.DocumentStatus.Approved)
                        {
                            statusBadgeClass = "background: #f0fdf4; color: #16a34a; border-color: rgba(22, 163, 74, 0.2);";
                            statusText = "Đã duyệt";
                            statusIcon = "check_circle";
                        }
                        else if (doc.Status == DMS.Models.DocumentStatus.Pending)
                        {
                            statusBadgeClass = "background: #fef2f2; color: #dc2626; border-color: rgba(220, 38, 38, 0.2);";
                            statusText = "Chờ duyệt";
                            statusIcon = "hourglass_empty";
                        }
                        else if (doc.Status == DMS.Models.DocumentStatus.Rejected)
                        {
                            statusBadgeClass = "background: #fef2f2; color: #dc2626; border-color: rgba(220, 38, 38, 0.2);";
                            statusText = "Từ chối";
                            statusIcon = "close";
                        }
                        else
                        {
                            statusBadgeClass = "background: #f3f4f6; color: #6b7280; border-color: rgba(107, 114, 128, 0.2);";
                            statusText = "Nháp";
                            statusIcon = "draft";
                        }

                        <tr>
                            <td>
                                <div class="document-info">
                                    <div class="document-icon blue">
                                        <span class="material-symbols-outlined">@fileIcon</span>
                                    </div>
                                    <div class="document-details">
                                        <h5>@doc.Title</h5>
                                        <p>@fileExtension.ToUpper() • @fileSizeMB MB</p>
                                    </div>
                                </div>
                            </td>
                            <td>@(doc.Course?.CourseCode ?? "N/A")</td>
                            <td style="color: #60758a; font-size: 14px;">@doc.UploadDate.ToString("dd MMM, yyyy", new System.Globalization.CultureInfo("vi-VN"))</td>
                            <td>
                                <span class="status-badge" style="@statusBadgeClass">
                                    <span class="material-symbols-outlined" style="font-size: 14px;">@statusIcon</span>
                                    @statusText
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons-group">
                                    <span style="font-size: 12px; color: #60758a; margin-right: 8px;">@doc.ViewCount lượt xem</span>
                                    <a href="@Url.Action("Preview", "Document", new { id = doc.Id })" class="action-btn" title="Xem">
                                        <span class="material-symbols-outlined" style="font-size: 20px;">visibility</span>
                                    </a>
                                    <button type="button" class="action-btn" title="Chia sẻ" onclick="openShareModal(@doc.Id, '@doc.Title')" style="border: none; background: none; cursor: pointer; padding: 0;">
                                        <span class="material-symbols-outlined" style="font-size: 20px;">share</span>
                                    </button>
                                    <a href="@Url.Action("Edit", "Document", new { id = doc.Id })" class="action-btn" title="Chỉnh sửa">
                                        <span class="material-symbols-outlined" style="font-size: 20px;">edit</span>
                                    </a>
                                    <form method="post" action="@Url.Action("Delete", "Document", new { id = doc.Id })" style="display: inline;" onsubmit="return confirm('Bạn có chắc muốn xóa tài liệu này?');">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="action-btn" title="Xóa" style="border: none; background: none; cursor: pointer; padding: 0;">
                                            <span class="material-symbols-outlined" style="font-size: 20px;">delete</span>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 32px; color: #6b7280;">
                            Chưa có tài liệu nào
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        @{
            var totalDocs = ViewBag.TotalDocuments ?? 0;
            var pageSize = ViewBag.PageSize ?? 4;
            var currentPage = ViewBag.Page ?? 1;
            var totalPages = ViewBag.TotalPages ?? 1;
            var startItem = totalDocs > 0 ? ((currentPage - 1) * pageSize) + 1 : 0;
            var endItem = Math.Min(currentPage * pageSize, totalDocs);
        }
        @if (totalDocs > 0)
        {
            <div class="pagination-wrapper">
                <div class="pagination-info">
                    <text>Hiển thị <strong>@startItem</strong> đến <strong>@endItem</strong> trong số <strong>@totalDocs</strong> kết quả</text>
                </div>
                <div class="pagination">
                    @if (currentPage > 1)
                    {
                        <a href="@Url.Action("InstructorDashboard", "Home", new { page = currentPage - 1 })" class="pagination-btn">
                            <span class="material-symbols-outlined" style="font-size: 20px;">chevron_left</span>
                        </a>
                    }
                    else
                    {
                        <span class="pagination-btn" style="opacity: 0.5; cursor: not-allowed;">
                            <span class="material-symbols-outlined" style="font-size: 20px;">chevron_left</span>
                        </span>
                    }
                    
                    @{
                        var startPage = Math.Max(1, currentPage - 1);
                        var endPage = Math.Min(totalPages, currentPage + 1);
                        
                        // Show first page if not in range
                        if (startPage > 1)
                        {
                            <a href="@Url.Action("InstructorDashboard", "Home", new { page = 1 })" class="pagination-btn">1</a>
                            if (startPage > 2)
                            {
                                <span class="pagination-btn" style="cursor: default;">...</span>
                            }
                        }
                        
                        // Show pages around current page
                        for (int i = startPage; i <= endPage; i++)
                        {
                            if (i == currentPage)
                            {
                                <span class="pagination-btn active">@i</span>
                            }
                            else
                            {
                                <a href="@Url.Action("InstructorDashboard", "Home", new { page = i })" class="pagination-btn">@i</a>
                            }
                        }
                        
                        // Show last page if not in range
                        if (endPage < totalPages)
                        {
                            if (endPage < totalPages - 1)
                            {
                                <span class="pagination-btn" style="cursor: default;">...</span>
                            }
                            <a href="@Url.Action("InstructorDashboard", "Home", new { page = totalPages })" class="pagination-btn">@totalPages</a>
                        }
                    }
                    
                    @if (currentPage < totalPages)
                    {
                        <a href="@Url.Action("InstructorDashboard", "Home", new { page = currentPage + 1 })" class="pagination-btn">
                            <span class="material-symbols-outlined" style="font-size: 20px;">chevron_right</span>
                        </a>
                    }
                    else
                    {
                        <span class="pagination-btn" style="opacity: 0.5; cursor: not-allowed;">
                            <span class="material-symbols-outlined" style="font-size: 20px;">chevron_right</span>
                        </span>
                    }
                </div>
            </div>
        }
    </div>
</div>
</div>

<!-- Share Modal -->
<div id="shareModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 1000; background: rgba(0, 0, 0, 0.5); align-items: center; justify-content: center;">
    <div class="modal-content" style="background: white; border-radius: 12px; width: 90%; max-width: 500px; padding: 24px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid #e5e7eb;">
            <h2 style="margin: 0; font-size: 20px; font-weight: 600; color: #111418;">Chia sẻ tài liệu</h2>
            <span class="close-button" onclick="closeShareModal()" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
        </div>
        <div class="modal-body">
            <form method="post" action="@Url.Action("Share", "Document")" id="shareForm">
                @Html.AntiForgeryToken()
                <input type="hidden" name="documentId" id="shareDocumentId" />
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 14px; font-weight: 600; color: #111418; margin-bottom: 8px;">
                        Tài liệu
                    </label>
                    <div style="padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <span id="shareDocumentTitle" style="font-size: 14px; color: #111418; font-weight: 500;"></span>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <label for="shareCourseId" style="display: block; font-size: 14px; font-weight: 600; color: #111418; margin-bottom: 8px;">
                        Chia sẻ với khóa học <span style="color: #dc2626;">*</span>
                    </label>
                    <select name="courseId" id="shareCourseId" required style="width: 100%; padding: 10px 14px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 15px; color: #111418; box-sizing: border-box;">
                        <option value="">-- Chọn khóa học --</option>
                        @if (ViewBag.AllCourses != null)
                        {
                            @foreach (var course in (List<DMS.Models.Course>)ViewBag.AllCourses)
                            {
                                var displayText = $"{course.CourseCode}";
                                if (!string.IsNullOrEmpty(course.ClassCode))
                                {
                                    displayText += $" - {course.ClassCode}";
                                }
                                displayText += $" - {course.CourseName}";
                                <option value="@course.Id">@displayText</option>
                            }
                        }
                    </select>
                    <small style="color: #6b7280; font-size: 12px; margin-top: 4px; display: block;">Tất cả sinh viên trong khóa học này sẽ có thể xem và tải xuống tài liệu</small>
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 12px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                    <button type="button" onclick="closeShareModal()" style="padding: 10px 20px; background: white; color: #6b7280; border: 1px solid #d1d5db; border-radius: 6px; font-weight: 500; cursor: pointer;">Hủy</button>
                    <button type="submit" style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background: #0959aa; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                        <span class="material-symbols-outlined">share</span>
                        Chia sẻ
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function openShareModal(documentId, documentTitle) {
        const shareModal = document.getElementById('shareModal');
        const shareDocumentId = document.getElementById('shareDocumentId');
        const shareDocumentTitle = document.getElementById('shareDocumentTitle');
        
        if (shareModal && shareDocumentId && shareDocumentTitle) {
            shareDocumentId.value = documentId;
            shareDocumentTitle.textContent = documentTitle;
            shareModal.style.display = 'flex';
        }
    }

    function closeShareModal() {
        const shareModal = document.getElementById('shareModal');
        if (shareModal) {
            shareModal.style.display = 'none';
            const shareForm = document.getElementById('shareForm');
            if (shareForm) {
                shareForm.reset();
            }
        }
    }

    window.addEventListener('click', (event) => {
        const shareModal = document.getElementById('shareModal');
        if (event.target == shareModal) {
            closeShareModal();
        }
    });
</script>

<style>
    /* Ensure pagination links display correctly */
    .pagination a.pagination-btn {
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    
    .pagination a.pagination-btn:hover {
        text-decoration: none;
    }
</style>

