@model DMS.ViewModels.QuizResultsVM
@{
    ViewData["Title"] = "Kết quả bài kiểm tra";
    Layout = "_SidebarLayout";
}

@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager

@{
    var currentUser = await UserManager.GetUserAsync(User);
    var isAdmin = false;
    if (currentUser != null)
    {
        var roles = await UserManager.GetRolesAsync(currentUser);
        isAdmin = roles.Contains("Admin");
    }
}

@if (isAdmin)
{
    <partial name="_AdminSidebar" />
}
else
{
    <partial name="_InstructorSidebar" />
}

<div class="main-content">
    <div class="content-header">
        <div class="header-title-section">
            <h1>Kết quả: @Model.Quiz.Title</h1>
            <p>Xem kết quả và chấm điểm bài làm của sinh viên</p>
        </div>
        <div class="header-actions">
            <a href="@Url.Action("Index", "Quiz")" class="btn btn-outline">Quay lại</a>
            <partial name="_NotificationDropdown" />
        </div>
    </div>

    <div class="content-body">
        <!-- Summary Cards -->
        <div class="results-summary-grid">
            <div class="summary-card">
                <div class="summary-card-icon blue">
                    <span class="material-symbols-outlined">people</span>
                </div>
                <div class="summary-card-content">
                    <div class="summary-card-label">Tổng sinh viên</div>
                    <div class="summary-card-value">@Model.TotalStudents</div>
                </div>
            </div>
            <div class="summary-card">
                <div class="summary-card-icon green">
                    <span class="material-symbols-outlined">check_circle</span>
                </div>
                <div class="summary-card-content">
                    <div class="summary-card-label">Đã hoàn thành</div>
                    <div class="summary-card-value">@Model.CompletedCount</div>
                </div>
            </div>
            <div class="summary-card">
                <div class="summary-card-icon orange">
                    <span class="material-symbols-outlined">trending_up</span>
                </div>
                <div class="summary-card-content">
                    <div class="summary-card-label">Điểm trung bình</div>
                    <div class="summary-card-value">@Model.AverageScore.ToString("F1")%</div>
                </div>
            </div>
            <div class="summary-card">
                <div class="summary-card-icon purple">
                    <span class="material-symbols-outlined">star</span>
                </div>
                <div class="summary-card-content">
                    <div class="summary-card-label">Tổng điểm</div>
                    <div class="summary-card-value">@(Model.Quiz.Questions?.Sum(q => q.Points) ?? 0)</div>
                </div>
            </div>
        </div>

        @if (Model.Attempts.Any())
        {
            <div class="results-table-container">
                <div class="results-table-header">
                    <h3>Danh sách bài làm</h3>
                </div>
                <div class="results-table-wrapper">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Sinh viên</th>
                                <th>Điểm số</th>
                                <th>Phần trăm</th>
                                <th>Thời gian nộp</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var attemptVM in Model.Attempts)
                            {
                                <tr>
                                    <td>
                                        <div class="student-info">
                                            <div class="student-avatar">
                                                <span class="material-symbols-outlined">person</span>
                                            </div>
                                            <div>
                                                <div class="student-name">@attemptVM.Student.FullName</div>
                                                <div class="student-email">@attemptVM.Student.Email</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="score-display">
                                            @if (attemptVM.Attempt.ManualScore.HasValue)
                                            {
                                                <strong class="score-value">@attemptVM.Attempt.ManualScore / @attemptVM.Attempt.MaxScore</strong>
                                                <span class="score-badge manual">Chấm thủ công</span>
                                            }
                                            else
                                            {
                                                <strong class="score-value">@(attemptVM.Attempt.TotalScore ?? 0) / @(attemptVM.Attempt.MaxScore ?? 0)</strong>
                                            }
                                        </div>
                                    </td>
                                    <td>
                                        @{
                                            var percentage = attemptVM.Attempt.ScorePercentage ?? 0;
                                            var badgeClass = percentage >= 80 ? "badge-excellent" : 
                                                             percentage >= 50 ? "badge-good" : "badge-poor";
                                        }
                                        <span class="badge @badgeClass">
                                            @percentage.ToString("F1")%
                                        </span>
                                    </td>
                                    <td>
                                        <div class="submission-time">
                                            <span class="material-symbols-outlined" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">schedule</span>
                                            @(attemptVM.Attempt.SubmittedAt?.ToString("dd/MM/yyyy HH:mm") ?? "")
                                        </div>
                                    </td>
                                    <td>
                                        <button type="button" class="btn-view-details" onclick="viewDetails(@attemptVM.Attempt.Id)">
                                            <span class="material-symbols-outlined">visibility</span>
                                            Xem chi tiết
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
        else
        {
            <div class="empty-state">
                <span class="material-symbols-outlined" style="font-size: 64px; color: #d1d5db;">assignment</span>
                <h3>Chưa có bài làm nào</h3>
                <p>Sinh viên chưa nộp bài kiểm tra này</p>
            </div>
        }
    </div>
</div>

<!-- Modal for attempt details -->
<div id="attemptModal" class="attempt-modal">
    <div class="attempt-modal-overlay" onclick="closeModal()"></div>
    <div class="attempt-modal-content">
        <div class="attempt-modal-header">
            <h2>Chi tiết bài làm</h2>
            <button onclick="closeModal()" class="attempt-modal-close">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="attempt-modal-body" id="attemptDetails">
            <div class="loading-spinner">
                <span class="material-symbols-outlined">hourglass_empty</span>
                <p>Đang tải...</p>
            </div>
        </div>
    </div>
</div>

<script>
    function viewDetails(attemptId) {
        const modal = document.getElementById('attemptModal');
        const detailsContainer = document.getElementById('attemptDetails');
        
        // Show modal with loading
        modal.style.display = 'flex';
        detailsContainer.innerHTML = '<div class="loading-spinner"><span class="material-symbols-outlined">hourglass_empty</span><p>Đang tải...</p></div>';
        
        // Load attempt details via AJAX
        fetch('@Url.Action("GetAttemptDetails", "Quiz")?attemptId=' + attemptId)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text();
            })
            .then(html => {
                detailsContainer.innerHTML = html;
            })
            .catch(error => {
                console.error('Error:', error);
                detailsContainer.innerHTML = '<div class="error-message"><span class="material-symbols-outlined">error</span><p>Lỗi khi tải chi tiết bài làm. Vui lòng thử lại.</p></div>';
            });
    }

    function closeModal() {
        document.getElementById('attemptModal').style.display = 'none';
    }
</script>

<style>
    /* Summary Cards */
    .results-summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
    }

    .summary-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        border: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        gap: 16px;
        transition: all 0.3s ease;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .summary-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .summary-card-icon {
        width: 56px;
        height: 56px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .summary-card-icon.blue {
        background: #dbeafe;
        color: #2563eb;
    }

    .summary-card-icon.green {
        background: #dcfce7;
        color: #16a34a;
    }

    .summary-card-icon.orange {
        background: #fed7aa;
        color: #ea580c;
    }

    .summary-card-icon.purple {
        background: #e9d5ff;
        color: #9333ea;
    }

    .summary-card-icon .material-symbols-outlined {
        font-size: 28px;
    }

    .summary-card-content {
        flex: 1;
    }

    .summary-card-label {
        font-size: 13px;
        color: #6b7280;
        margin-bottom: 6px;
    }

    .summary-card-value {
        font-size: 28px;
        font-weight: 700;
        color: #111418;
    }

    /* Results Table */
    .results-table-container {
        background: white;
        border-radius: 16px;
        border: 1px solid #e5e7eb;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .results-table-header {
        padding: 20px 24px;
        border-bottom: 1px solid #e5e7eb;
        background: #f9fafb;
    }

    .results-table-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 700;
        color: #111418;
    }

    .results-table-wrapper {
        overflow-x: auto;
    }

    .results-table {
        width: 100%;
        border-collapse: collapse;
    }

    .results-table thead {
        background: #f9fafb;
    }

    .results-table th {
        padding: 16px 24px;
        text-align: left;
        font-size: 13px;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 2px solid #e5e7eb;
    }

    .results-table tbody tr {
        border-bottom: 1px solid #e5e7eb;
        transition: background 0.2s ease;
    }

    .results-table tbody tr:hover {
        background: #f9fafb;
    }

    .results-table td {
        padding: 20px 24px;
        vertical-align: middle;
    }

    .student-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .student-avatar {
        width: 40px;
        height: 40px;
        background: #e5e7eb;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6b7280;
    }

    .student-name {
        font-weight: 600;
        color: #111418;
        margin-bottom: 2px;
    }

    .student-email {
        font-size: 13px;
        color: #6b7280;
    }

    .score-display {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .score-value {
        font-size: 16px;
        font-weight: 700;
        color: #111418;
    }

    .score-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
    }

    .score-badge.manual {
        background: #fef3c7;
        color: #d97706;
    }

    .badge {
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
        display: inline-block;
    }

    .badge-excellent {
        background: #dcfce7;
        color: #16a34a;
    }

    .badge-good {
        background: #fef3c7;
        color: #d97706;
    }

    .badge-poor {
        background: #fee2e2;
        color: #dc2626;
    }

    .submission-time {
        display: flex;
        align-items: center;
        font-size: 14px;
        color: #6b7280;
    }

    .btn-view-details {
        padding: 8px 16px;
        background: #dcfce7;
        color: #16a34a;
        border: 1px solid #86efac;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s ease;
    }

    .btn-view-details:hover {
        background: #bbf7d0;
        border-color: #4ade80;
        transform: translateY(-1px);
    }

    /* Modal */
    .attempt-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 10000;
        align-items: center;
        justify-content: center;
    }

    .attempt-modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
    }

    .attempt-modal-content {
        position: relative;
        background: white;
        border-radius: 16px;
        max-width: 900px;
        max-height: 90vh;
        width: 90%;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        animation: modalSlideIn 0.3s ease-out;
    }

    @@keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .attempt-modal-header {
        padding: 24px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .attempt-modal-header h2 {
        margin: 0;
        font-size: 20px;
        font-weight: 700;
        color: #111418;
    }

    .attempt-modal-close {
        background: none;
        border: none;
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        color: #6b7280;
        transition: all 0.2s ease;
    }

    .attempt-modal-close:hover {
        background: #f3f4f6;
        color: #111418;
    }

    .attempt-modal-body {
        padding: 24px;
        overflow-y: auto;
        flex: 1;
    }

    .loading-spinner {
        text-align: center;
        padding: 60px 20px;
        color: #6b7280;
    }

    .loading-spinner .material-symbols-outlined {
        font-size: 48px;
        animation: spin 1s linear infinite;
        margin-bottom: 16px;
    }

    @@keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .error-message {
        text-align: center;
        padding: 60px 20px;
        color: #dc2626;
    }

    .error-message .material-symbols-outlined {
        font-size: 48px;
        margin-bottom: 16px;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 80px 20px;
        background: white;
        border-radius: 16px;
        border: 2px dashed #e5e7eb;
    }

    .empty-state .material-symbols-outlined {
        font-size: 80px;
        color: #d1d5db;
        margin-bottom: 16px;
    }

    .empty-state h3 {
        margin: 16px 0 8px;
        color: #111418;
        font-size: 20px;
        font-weight: 600;
    }

    .empty-state p {
        color: #6b7280;
        font-size: 15px;
    }
</style>

