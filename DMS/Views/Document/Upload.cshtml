@{
    ViewData["Title"] = "Upload New Document";
    Layout = "_SidebarLayout";
}

@model DMS.ViewModels.DocumentUploadVM

@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager

@{
    var currentUser = await UserManager.GetUserAsync(User);
    var isAdmin = false;
    if (currentUser != null)
    {
        var roles = await UserManager.GetRolesAsync(currentUser);
        isAdmin = roles.Contains("Admin");
    }
}

@if (isAdmin)
{
    <partial name="_AdminSidebar" />
}
else
{
    <partial name="_InstructorSidebar" />
}

<div class="main-content">
    <!-- Header -->
    <div class="content-header">
        <div class="header-title-section">
            <div class="breadcrumbs">
                <a href="@Url.Action("Index", "Home")">Home</a>
                <span>/</span>
                <a href="@Url.Action("MyDocuments", "Home")">Documents</a>
                <span>/</span>
                <span>Upload</span>
            </div>
            <h1>Upload New Document</h1>
            <p>Please follow the workflow to submit your document for academic review.</p>
        </div>
        <div class="header-actions">
            <button class="notification-icon">
                <span class="material-symbols-outlined">notifications</span>
                <span class="notification-dot"></span>
            </button>
        </div>
    </div>

    <!-- Content Body -->
    <div class="content-body">
        <form asp-action="Upload" method="post" enctype="multipart/form-data" class="upload-form">
            @Html.AntiForgeryToken()

            <!-- Workflow Stepper -->
            <div class="workflow-stepper">
                <div class="stepper-step completed">
                    <div class="step-circle">
                        <span class="material-symbols-outlined">check</span>
                    </div>
                    <span class="step-label">Upload</span>
                </div>
                <div class="stepper-line completed"></div>
                <div class="stepper-step active">
                    <div class="step-circle">
                        <span>2</span>
                    </div>
                    <span class="step-label">Details</span>
                </div>
                <div class="stepper-line"></div>
                <div class="stepper-step">
                    <div class="step-circle">
                        <span>3</span>
                    </div>
                    <span class="step-label">Permissions</span>
                </div>
                <div class="stepper-line"></div>
                <div class="stepper-step">
                    <div class="step-circle">
                        <span>4</span>
                    </div>
                    <span class="step-label">Review</span>
                </div>
            </div>

            <div class="upload-content-layout">
                <!-- Main Content -->
                <div class="upload-main-content">
                    <!-- Uploaded File Section -->
                    <div class="uploaded-file-card" id="uploadedFileCard" style="display: none;">
                        <div class="uploaded-file-info">
                            <div class="file-icon-large">
                                <span class="material-symbols-outlined" id="uploadedFileIcon">picture_as_pdf</span>
                            </div>
                            <div class="file-details-large">
                                <h4 id="uploadedFileName">research_paper_v2_final_draft.pdf</h4>
                                <p id="uploadedFileSize">2.4 MB</p>
                                <div class="upload-status">
                                    <span class="material-symbols-outlined" style="color: #16a34a;">check_circle</span>
                                    <span>Upload Complete</span>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn-replace" id="replaceFileBtn">Replace</button>
                    </div>

                    <!-- Upload Zone (shown when no file) -->
                    <div class="upload-zone-card" id="uploadZoneCard">
                        <div class="upload-zone" id="uploadZone">
                            <div class="upload-zone-content">
                                <span class="material-symbols-outlined upload-icon-large">cloud_upload</span>
                                <h3>Drag and drop your file here</h3>
                                <p>or click to browse</p>
                                <input type="file" asp-for="File" id="fileInput" class="file-input" accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx" />
                                <label for="fileInput" class="upload-btn-label">
                                    <span class="material-symbols-outlined">folder</span>
                                    Choose File
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Document Information -->
                    <div class="form-card">
                        <div class="card-header">
                            <span class="material-symbols-outlined card-icon">edit</span>
                            <h3>Document Information</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label asp-for="Title" class="form-label">Document Title <span class="required">*</span></label>
                                <input asp-for="Title" class="form-input" placeholder="e.g. Analysis of Renaissance Art in Northern Europe" />
                                <span asp-validation-for="Title" class="text-danger"></span>
                            </div>

                            <div class="form-group">
                                <label asp-for="Description" class="form-label">Description</label>
                                <textarea asp-for="Description" class="form-textarea" rows="4" placeholder="Provide a brief abstract or summary of the document contents..."></textarea>
                                <span asp-validation-for="Description" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Academic Context -->
                    <div class="form-card">
                        <div class="card-header">
                            <span class="material-symbols-outlined card-icon">school</span>
                            <h3>Academic Context</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label asp-for="CourseId" class="form-label">Academic Unit <span class="required">*</span></label>
                                <select asp-for="CourseId" class="form-select" asp-items="@(new SelectList(ViewBag.Courses ?? new List<DMS.Models.Course>(), "Id", "CourseName"))">
                                    <option value="">Select Department</option>
                                </select>
                                <span asp-validation-for="CourseId" class="text-danger"></span>
                            </div>

                            <div class="form-group">
                                <label asp-for="FolderId" class="form-label">Associated Course (Optional)</label>
                                <select asp-for="FolderId" class="form-select" asp-items="@(new SelectList(ViewBag.Folders ?? new List<DMS.Models.Folder>(), "Id", "FolderName"))">
                                    <option value="">Select Course Code</option>
                                </select>
                                <span asp-validation-for="FolderId" class="text-danger"></span>
                            </div>

                            <div class="form-group">
                                <label asp-for="Tags" class="form-label">Keywords / Tags</label>
                                <div class="tags-input-container">
                                    <div class="tags-display" id="tagsDisplay"></div>
                                    <input type="text" id="tagsInput" class="tags-input" placeholder="Type and press Enter..." />
                                </div>
                                <small class="form-hint">Suggested: #research, #draft</small>
                                <input type="hidden" asp-for="Tags" id="tagsHidden" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="upload-sidebar">
                    <!-- Submission Tips -->
                    <div class="sidebar-card">
                        <div class="sidebar-card-header">
                            <span class="material-symbols-outlined sidebar-icon" style="color: #f97316;">lightbulb</span>
                            <h4>Submission Tips</h4>
                        </div>
                        <div class="sidebar-card-body">
                            <div class="tip-item">
                                <span class="material-symbols-outlined tip-icon">check_circle</span>
                                <p>Ensure your title is descriptive and matches the official course syllabus if applicable.</p>
                            </div>
                            <div class="tip-item">
                                <span class="material-symbols-outlined tip-icon">check_circle</span>
                                <p>Add at least 3 tags to improve searchability within the department DMS.</p>
                            </div>
                            <div class="tip-item">
                                <span class="material-symbols-outlined tip-icon">check_circle</span>
                                <p>Confidential documents should be marked as "Private" in the next step.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Approval Workflow -->
                    <div class="sidebar-card">
                        <div class="sidebar-card-header">
                            <h4>Approval Workflow</h4>
                        </div>
                        <div class="sidebar-card-body">
                            <div class="workflow-step-item current">
                                <div class="workflow-dot"></div>
                                <div>
                                    <strong>CURRENT</strong>
                                    <p>Student Submission</p>
                                </div>
                            </div>
                            <div class="workflow-step-item">
                                <div class="workflow-dot inactive"></div>
                                <div>
                                    <strong>STEP 2</strong>
                                    <p>System Check (Anti-plagiarism)</p>
                                </div>
                            </div>
                            <div class="workflow-step-item">
                                <div class="workflow-dot inactive"></div>
                                <div>
                                    <strong>STEP 3</strong>
                                    <p>Advisor Approval</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bottom Action Bar -->
            <div class="action-bar">
                <button type="button" class="btn-back" onclick="window.history.back()">
                    <span class="material-symbols-outlined">arrow_back</span>
                    Back
                </button>
                <button type="button" class="btn-save-draft">
                    <span class="material-symbols-outlined">save</span>
                    Save Draft
                </button>
                <button type="submit" class="btn-continue" id="submitBtn" disabled>
                    Continue
                    <span class="material-symbols-outlined">arrow_forward</span>
                </button>
            </div>
        </form>
    </div>
</div>

<style>
.breadcrumbs {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: #6b7280;
    margin-bottom: 8px;
}

.breadcrumbs a {
    color: #0959aa;
    text-decoration: none;
}

.breadcrumbs a:hover {
    text-decoration: underline;
}

.breadcrumbs span {
    color: #9ca3af;
}

/* Workflow Stepper */
.workflow-stepper {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 32px;
    padding: 24px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    border: 1px solid #e5e7eb;
}

.stepper-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}

.step-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 16px;
    background: #e5e7eb;
    color: #6b7280;
    border: 2px solid #e5e7eb;
}

.stepper-step.completed .step-circle {
    background: #0959aa;
    color: white;
    border-color: #0959aa;
}

.stepper-step.active .step-circle {
    background: #0959aa;
    color: white;
    border-color: #0959aa;
}

.step-label {
    font-size: 14px;
    font-weight: 500;
    color: #6b7280;
}

.stepper-step.active .step-label,
.stepper-step.completed .step-label {
    color: #0959aa;
}

.stepper-line {
    width: 100px;
    height: 2px;
    background: #e5e7eb;
    margin: 0 16px;
    margin-top: -20px;
}

.stepper-line.completed {
    background: #0959aa;
}

/* Upload Content Layout */
.upload-content-layout {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 24px;
    margin-bottom: 32px;
}

.upload-main-content {
    display: flex;
    flex-direction: column;
    gap: 24px;
}

/* Uploaded File Card */
.uploaded-file-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    border: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.uploaded-file-info {
    display: flex;
    align-items: center;
    gap: 16px;
}

.file-icon-large {
    width: 64px;
    height: 64px;
    background: #fee2e2;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    color: #dc2626;
}

.file-details-large h4 {
    font-size: 16px;
    font-weight: 600;
    color: #111418;
    margin: 0 0 4px 0;
}

.file-details-large p {
    font-size: 14px;
    color: #6b7280;
    margin: 0 0 8px 0;
}

.upload-status {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 14px;
    color: #16a34a;
}

.btn-replace {
    padding: 10px 20px;
    background: #0959aa;
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-replace:hover {
    background: #075985;
}

/* Upload Zone Card */
.upload-zone-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    border: 1px solid #e5e7eb;
}

.upload-zone {
    border: 2px dashed #d1d5db;
    border-radius: 12px;
    padding: 48px 24px;
    text-align: center;
    background: #f9fafb;
    cursor: pointer;
    transition: all 0.3s;
}

.upload-zone:hover {
    border-color: #0959aa;
    background: #f0f9ff;
}

.upload-zone.drag-over {
    border-color: #0959aa;
    background: #f0f9ff;
    border-style: solid;
}

.upload-zone-content {
    pointer-events: none;
}

.upload-icon-large {
    font-size: 64px;
    color: #6b7280;
    margin-bottom: 16px;
}

.upload-zone h3 {
    font-size: 18px;
    font-weight: 600;
    color: #111418;
    margin: 0 0 8px 0;
}

.upload-zone p {
    font-size: 14px;
    color: #6b7280;
    margin: 0 0 16px 0;
}

.file-input {
    display: none;
}

.upload-btn-label {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    background: #0959aa;
    color: white;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
    pointer-events: auto;
}

.upload-btn-label:hover {
    background: #075985;
}

/* Form Card */
.form-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    border: 1px solid #e5e7eb;
}

.card-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid #e5e7eb;
}

.card-icon {
    font-size: 24px;
    color: #0959aa;
}

.card-header h3 {
    font-size: 18px;
    font-weight: 600;
    color: #111418;
    margin: 0;
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: #111418;
    margin-bottom: 8px;
}

.form-label .required {
    color: #dc2626;
}

.form-input,
.form-textarea,
.form-select {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 15px;
    color: #111418;
    transition: all 0.2s;
    font-family: inherit;
}

.form-input:focus,
.form-textarea:focus,
.form-select:focus {
    outline: none;
    border-color: #0959aa;
    box-shadow: 0 0 0 3px rgba(9, 89, 170, 0.1);
}

.form-textarea {
    resize: vertical;
    min-height: 100px;
}

.form-hint {
    display: block;
    font-size: 12px;
    color: #6b7280;
    margin-top: 4px;
}

/* Tags Input */
.tags-input-container {
    border: 1px solid #d1d5db;
    border-radius: 8px;
    padding: 8px;
    min-height: 48px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    background: white;
}

.tags-display {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.tag-chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: #0959aa;
    color: white;
    border-radius: 16px;
    font-size: 14px;
    font-weight: 500;
}

.tag-chip .remove-tag {
    cursor: pointer;
    display: flex;
    align-items: center;
    font-size: 18px;
    opacity: 0.8;
}

.tag-chip .remove-tag:hover {
    opacity: 1;
}

.tags-input {
    flex: 1;
    border: none;
    outline: none;
    padding: 4px;
    font-size: 14px;
    min-width: 150px;
}

/* Sidebar */
.upload-sidebar {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.sidebar-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    border: 1px solid #e5e7eb;
}

.sidebar-card-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
}

.sidebar-icon {
    font-size: 24px;
}

.sidebar-card-header h4 {
    font-size: 16px;
    font-weight: 600;
    color: #111418;
    margin: 0;
}

.sidebar-card-body {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.tip-item {
    display: flex;
    gap: 12px;
    align-items: flex-start;
}

.tip-icon {
    font-size: 20px;
    color: #16a34a;
    flex-shrink: 0;
    margin-top: 2px;
}

.tip-item p {
    font-size: 14px;
    color: #6b7280;
    margin: 0;
    line-height: 1.5;
}

.workflow-step-item {
    display: flex;
    gap: 12px;
    align-items: flex-start;
}

.workflow-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #0959aa;
    flex-shrink: 0;
    margin-top: 4px;
}

.workflow-dot.inactive {
    background: #d1d5db;
}

.workflow-step-item strong {
    font-size: 12px;
    color: #6b7280;
    display: block;
    margin-bottom: 2px;
}

.workflow-step-item.current strong {
    color: #0959aa;
}

.workflow-step-item p {
    font-size: 14px;
    color: #111418;
    margin: 0;
}

/* Action Bar */
.action-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 0;
    border-top: 1px solid #e5e7eb;
    margin-top: 32px;
}

.btn-back {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    background: white;
    color: #6b7280;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-back:hover {
    background: #f9fafb;
    border-color: #9ca3af;
}

.btn-save-draft {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    background: white;
    color: #6b7280;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-save-draft:hover {
    background: #f9fafb;
    border-color: #9ca3af;
}

.btn-continue {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    background: #0959aa;
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-continue:hover:not(:disabled) {
    background: #075985;
}

.btn-continue:disabled {
    background: #d1d5db;
    cursor: not-allowed;
}

@@media (max-width: 1024px) {
    .upload-content-layout {
        grid-template-columns: 1fr;
    }
}
</style>

@section Scripts {
    <script>
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const uploadedFileCard = document.getElementById('uploadedFileCard');
        const uploadZoneCard = document.getElementById('uploadZoneCard');
        const uploadedFileName = document.getElementById('uploadedFileName');
        const uploadedFileSize = document.getElementById('uploadedFileSize');
        const uploadedFileIcon = document.getElementById('uploadedFileIcon');
        const replaceFileBtn = document.getElementById('replaceFileBtn');
        const submitBtn = document.getElementById('submitBtn');
        const tagsInput = document.getElementById('tagsInput');
        const tagsDisplay = document.getElementById('tagsDisplay');
        const tagsHidden = document.getElementById('tagsHidden');
        let tags = [];

        // Drag & Drop
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('drag-over');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('drag-over');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect(files[0]);
            }
        });

        uploadZone.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });

        function handleFileSelect(file) {
            // Validate file size (50MB)
            if (file.size > 50 * 1024 * 1024) {
                alert('File quá lớn! Vui lòng chọn file nhỏ hơn 50MB');
                return;
            }

            // Show uploaded file card
            uploadedFileName.textContent = file.name;
            uploadedFileSize.textContent = formatFileSize(file.size);
            
            // Update icon based on file type
            if (file.name.endsWith('.pdf')) {
                uploadedFileIcon.textContent = 'picture_as_pdf';
                uploadedFileIcon.style.color = '#dc2626';
            } else if (file.name.endsWith('.doc') || file.name.endsWith('.docx')) {
                uploadedFileIcon.textContent = 'description';
                uploadedFileIcon.style.color = '#2563eb';
            } else if (file.name.endsWith('.ppt') || file.name.endsWith('.pptx')) {
                uploadedFileIcon.textContent = 'slideshow';
                uploadedFileIcon.style.color = '#ea580c';
            } else if (file.name.endsWith('.xls') || file.name.endsWith('.xlsx')) {
                uploadedFileIcon.textContent = 'table_chart';
                uploadedFileIcon.style.color = '#16a34a';
            } else {
                uploadedFileIcon.textContent = 'insert_drive_file';
                uploadedFileIcon.style.color = '#6b7280';
            }

            uploadedFileCard.style.display = 'flex';
            uploadZoneCard.style.display = 'none';
            submitBtn.disabled = false;
        }

        replaceFileBtn.addEventListener('click', () => {
            fileInput.click();
        });

        // Tags handling
        tagsInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const tag = tagsInput.value.trim();
                if (tag && !tags.includes(tag)) {
                    tags.push(tag);
                    updateTagsDisplay();
                    tagsInput.value = '';
                }
            }
        });

        function updateTagsDisplay() {
            tagsDisplay.innerHTML = '';
            tags.forEach((tag, index) => {
                const chip = document.createElement('div');
                chip.className = 'tag-chip';
                chip.innerHTML = `
                    ${tag}
                    <span class="remove-tag" data-index="${index}">×</span>
                `;
                tagsDisplay.appendChild(chip);
            });
            tagsHidden.value = tags.join(',');
            
            // Add remove listeners
            document.querySelectorAll('.remove-tag').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    tags.splice(index, 1);
                    updateTagsDisplay();
                });
            });
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
    </script>
}
